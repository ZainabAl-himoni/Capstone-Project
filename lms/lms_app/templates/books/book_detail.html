{% extends 'base.html' %}

{% block title %}{{ book.title }} - Details{% endblock %}

{% block content %}
<br>
<h1>Book Details</h1>

<div style="max-width: 600px; margin: 0 auto; padding: 20px;">

    {% if book.photo_book %}
        <img src="{{ book.photo_book.url }}" alt="{{ book.title }}" style="width:100%; max-height:300px; object-fit:contain; margin-bottom:15px;">
    {% else %}
        <img src="https://via.placeholder.com/300x300" alt="No Image" style="width:100%; max-height:300px; object-fit:contain; margin-bottom:15px;">
    {% endif %}

    <h2 style="margin-bottom:10px;">{{ book.title }}</h2>

    <p>
        Rating:
        {% for i in "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ" %}
            {% if forloop.counter <= book.rating %}
                <span style="color:#eba121ff;">‚òÖ</span>
            {% else %}
                <span style="color:#ccc;">‚òÜ</span>
            {% endif %}
        {% endfor %}
    </p>

    <p><strong>Author:</strong> {{ book.author }}</p>
    <p><strong>Category:</strong> {{ book.category }}</p>
    <p><strong>Price:</strong> ${{ book.price }}</p>
    <p><strong>Status:</strong> {{ book.status }}</p>
    <p><strong>Description:</strong></p>
    <p>{{ book.description }}</p>

    {% if user.is_authenticated and comment.user == user %}
    <div style="display:flex; gap:0; border: 2px solid; border-image: linear-gradient(to right, blue, green) 1; border-radius:5px; overflow:hidden;">
        <button class="btn-edit" data-id="{{ comment.id }}" style="background:#ff9800; color:white; border:none; padding:5px 10px;">Edit</button>
        <button class="btn-delete" data-id="{{ comment.id }}" style="background:#f44336; color:white; border:none; padding:5px 10px;">Delete</button>
    </div>
{% elif not user.is_authenticated and comment.id in visitor_comments %}
    <div style="display:flex; gap:0; border: 2px solid; border-image: linear-gradient(to right, blue, green) 1; border-radius:5px; overflow:hidden;">
        <button class="btn-edit" data-id="{{ comment.id }}" style="background:#ff9800; color:white; border:none; padding:5px 10px;">Edit</button>
        <button class="btn-delete" data-id="{{ comment.id }}" style="background:#f44336; color:white; border:none; padding:5px 10px;">Delete</button>
    </div>
{% endif %}

    <a href="{% url 'home' %}" class="btn btn-custom orange" style="margin-top:10px;">Back to Home üè°</a>

    <hr style="margin:30px 0;">

<div id="comment-box" style="margin-bottom:20px; border:1px solid #ddd; padding:15px; border-radius:8px; background:#f9f9f9;">
    <h4 style="color:#007bff;">Add comment</h4><br>

    <form method="post" style="display:flex; flex-direction:column; gap:10px;">
        {% csrf_token %}
        {% if not user.is_authenticated %}
            <input type="text" name="name" id="id_name" 
                   placeholder="Your name (optional)" 
                   style="padding:5px; width:150px; border:1px solid #ccc; border-radius:5px;">
        {% endif %}

        <textarea name="text" rows="4" placeholder="Add a comment..." 
                  style="width:100%; padding:5px; border:1px solid #ccc; border-radius:5px;"></textarea>

        <button type="submit" class="btn btn-custom" 
                style="background-color:#007bff; color:white; padding:5px 15px; border-radius:5px; border:none; width:100px;">
            submit
        </button>
    </form>
</div>





   
 
 <div class="comments">
    {% for comment in comments reversed %}
        <div class="comment" id="comment-{{ comment.id }}" style="border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px; background:#fff;">
            <strong>
                {% if comment.user %}
                    {{ comment.user.username }}
                {% else %}
                    {{ comment.name|default:"Anonymous" }}
                {% endif %}
            </strong>
            <p class="comment-text">{{ comment.text }}</p>

            {% if user.is_authenticated and comment.user == user %}
                <button class="btn-edit" data-id="{{ comment.id }}" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:5px; margin-right:5px;">Edit</button>
                <button class="btn-delete" data-id="{{ comment.id }}" style="background:#f44336; color:white; border:none; padding:5px 10px; border-radius:5px;">Delete</button>
            {% elif not user.is_authenticated and comment.id in visitor_comments %}
                <button class="btn-edit" data-id="{{ comment.id }}" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:5px; margin-right:5px;">Edit</button>
                <button class="btn-delete" data-id="{{ comment.id }}" style="background:#f44336; color:white; border:none; padding:5px 10px; border-radius:5px;">Delete</button>
            {% endif %}
        </div>
    {% empty %}
        <p>No comments yet. Be the first!</p>
    {% endfor %}
</div>


</div>

<div id="message-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    {% if messages %}
        {% for message in messages %}
            <div class="alert" style="background-color:#4caf50; color:white; padding:10px 20px; border-radius:5px; margin-bottom:5px;">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
</div>

<script>
setTimeout(function() {
    const container = document.getElementById('message-container');
    if (container) {
        container.style.transition = 'opacity 0.5s ease';
        container.style.opacity = '0';
        setTimeout(() => container.style.display = 'none', 500);
    }
}, 3000);

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener("DOMContentLoaded", function() {

    document.querySelectorAll(".btn-edit").forEach(button => {
        button.addEventListener("click", function() {
            const commentId = this.dataset.id;
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const commentText = commentDiv.querySelector(".comment-text").innerText;

            const form = document.createElement("form");
            form.innerHTML = `
                <textarea name="text" rows="3" style="width:100%;">${commentText}</textarea>
                <button type="submit" style="margin-top:5px; padding:5px 10px; border-radius:5px;">Save</button>
                <button type="button" class="cancel-edit" style="margin-top:5px; padding:5px 10px; border-radius:5px;">Cancel</button>
            `;

            commentDiv.querySelector(".comment-text").style.display = "none";
            commentDiv.appendChild(form);

            form.querySelector(".cancel-edit").addEventListener("click", () => {
                form.remove();
                commentDiv.querySelector(".comment-text").style.display = "block";
            });

            form.addEventListener("submit", function(e) {
                e.preventDefault();
                const newText = this.querySelector("textarea").value.trim();
                if (!newText) return alert("Comment cannot be empty!");

                fetch(`/comment/edit/${commentId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({ text: newText })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        commentDiv.querySelector(".comment-text").innerText = data.new_text;
                        commentDiv.querySelector(".comment-text").style.display = "block";
                        form.remove();
                    } else {
                        alert(data.error || "Something went wrong!");
                    }
                })
                .catch(err => console.error("Error:", err));
            });
        });
    });

    document.querySelectorAll(".btn-delete").forEach(button => {
        button.addEventListener("click", function() {
            const commentId = this.dataset.id;
            if (!confirm("Are you sure you want to delete this comment?")) return;

            fetch(`/comment/delete/${commentId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`comment-${commentId}`).remove();
                } else {
                    alert(data.error || "Error deleting comment.");
                }
            })
            .catch(err => console.error("Error:", err));
        });
    });

});
</script>

{% endblock %}
